# Multi-stage build: build Vite app, then serve with Nginx

FROM node:20-alpine AS builder
WORKDIR /app

# Install deps
COPY package*.json ./
RUN npm ci --no-audit --no-fund

# Build
COPY . .

# Optional build-time Vite envs (used to generate .env.production)
ARG VITE_MQTT_BROKER
ARG VITE_MQTT_USERNAME
ARG VITE_MQTT_PASSWORD
ARG VITE_MQTT_TOPIC

# If any ARG is provided, create a .env.production file for Vite
RUN set -eux; \
		if [ -n "${VITE_MQTT_BROKER:-}" ] || [ -n "${VITE_MQTT_USERNAME:-}" ] || [ -n "${VITE_MQTT_PASSWORD:-}" ] || [ -n "${VITE_MQTT_TOPIC:-}" ]; then \
			echo "# auto-generated by Docker build" > .env.production; \
			[ -n "${VITE_MQTT_BROKER:-}" ] && echo "VITE_MQTT_BROKER=${VITE_MQTT_BROKER}" >> .env.production || true; \
			[ -n "${VITE_MQTT_USERNAME:-}" ] && echo "VITE_MQTT_USERNAME=${VITE_MQTT_USERNAME}" >> .env.production || true; \
			[ -n "${VITE_MQTT_PASSWORD:-}" ] && echo "VITE_MQTT_PASSWORD=${VITE_MQTT_PASSWORD}" >> .env.production || true; \
			[ -n "${VITE_MQTT_TOPIC:-}" ] && echo "VITE_MQTT_TOPIC=${VITE_MQTT_TOPIC}" >> .env.production || true; \
		fi; \
		npm run build

FROM nginx:1.27-alpine AS runtime

# Replace default nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy compiled app
COPY --from=builder /app/dist /usr/share/nginx/html

EXPOSE 80

# Use default nginx start command
